<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Textproduktion Trainer ¬∑ St. Anna</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìù</text></svg>">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* ============================
   DESIGN: Refined Editorial
   ============================ */
:root {
  --ink: #1a1a2e;
  --ink-light: #4a4a6a;
  --ink-muted: #8888a4;
  --accent: #2563eb;
  --accent-hover: #1d4ed8;
  --accent-soft: #dbeafe;
  --accent-glow: rgba(37, 99, 235, 0.08);
  --surface: #ffffff;
  --bg: #f0f0f5;
  --bg-warm: #fafafa;
  --border: #e2e2ec;
  --border-light: #f0f0f5;
  --success: #059669;
  --success-bg: #ecfdf5;
  --warning: #dc2626;
  --warning-bg: #fef2f2;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow-sm: 0 1px 3px rgba(26,26,46,0.06);
  --shadow-md: 0 4px 16px rgba(26,26,46,0.08);
  --shadow-lg: 0 8px 32px rgba(26,26,46,0.12);
  --font-display: 'DM Serif Display', Georgia, serif;
  --font-body: 'DM Sans', -apple-system, sans-serif;
  --font-mono: 'JetBrains Mono', 'Courier New', monospace;
}

/* ====== DARK MODE ====== */
[data-theme="dark"] {
  --ink: #e4e4ed;
  --ink-light: #b0b0c8;
  --ink-muted: #7878a0;
  --accent: #60a5fa;
  --accent-hover: #93bbfd;
  --accent-soft: rgba(96, 165, 250, 0.15);
  --accent-glow: rgba(96, 165, 250, 0.08);
  --surface: #1e1e2e;
  --bg: #14141f;
  --bg-warm: #1a1a28;
  --border: #2e2e42;
  --border-light: #252538;
  --success: #34d399;
  --success-bg: rgba(52,211,153,0.1);
  --warning: #f87171;
  --warning-bg: rgba(248,113,113,0.1);
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.2);
  --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
  --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
}

*,*::before,*::after { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: var(--font-body);
  background: var(--bg);
  color: var(--ink);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  line-height: 1.6;
  -webkit-font-smoothing: antialiased;
}

/* ====== LOGIN ====== */
#login-screen {
  position: fixed;
  inset: 0;
  background: var(--ink);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
#login-screen::before {
  content: '';
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse at 20% 50%, rgba(37,99,235,0.15) 0%, transparent 60%),
    radial-gradient(ellipse at 80% 20%, rgba(37,99,235,0.1) 0%, transparent 50%);
}
.login-box {
  position: relative;
  background: var(--surface);
  padding: 3rem;
  border-radius: 16px;
  box-shadow: var(--shadow-lg);
  text-align: center;
  max-width: 400px;
  width: 90%;
  animation: fadeUp .5s ease-out;
}
.login-box h2 {
  font-family: var(--font-display);
  font-size: 1.6rem;
  margin-bottom: .4rem;
  color: var(--ink);
}
.login-box p {
  color: var(--ink-muted);
  margin-bottom: 1.5rem;
  font-size: .95rem;
}
.login-box .school-badge {
  display: inline-block;
  background: var(--accent-soft);
  color: var(--accent);
  padding: .3rem .8rem;
  border-radius: 20px;
  font-size: .8rem;
  font-weight: 600;
  margin-bottom: 1.2rem;
  letter-spacing: .03em;
}
.login-input {
  width: 100%;
  padding: .85rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: 1rem;
  transition: border-color .2s;
  outline: none;
}
.login-input:focus {
  border-color: var(--accent);
}
.login-error {
  color: var(--warning);
  display: none;
  font-weight: 600;
  font-size: .85rem;
  margin-top: .8rem;
}

/* ====== BUTTONS ====== */
.btn {
  display: inline-flex;
  align-items: center;
  gap: .5rem;
  background: var(--accent);
  color: white;
  border: none;
  padding: .75rem 1.5rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 600;
  font-size: .95rem;
  transition: all .2s;
  letter-spacing: .01em;
}
.btn:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
.btn:active { transform: translateY(0); }
.btn:disabled { opacity: .5; cursor: not-allowed; transform: none; }
.btn-secondary {
  background: transparent;
  color: var(--accent);
  border: 2px solid var(--accent);
}
.btn-secondary:hover { background: var(--accent-soft); }
.btn-small { padding: .5rem 1rem; font-size: .85rem; }
.btn-danger { background: var(--warning); }
.btn-danger:hover { background: #b91c1c; }

/* ====== APP WRAPPER ====== */
#app-wrapper { display: none; flex-direction: column; min-height: 100vh; }

/* ====== HEADER ====== */
header {
  background: var(--surface);
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
  background: rgba(255,255,255,0.92);
}
header h1 {
  font-family: var(--font-display);
  font-size: 1.3rem;
  color: var(--ink);
}
header h1 span {
  color: var(--accent);
}
.header-meta {
  font-size: .8rem;
  color: var(--ink-muted);
  font-weight: 500;
}

/* ====== NAV STEPS ====== */
nav {
  background: var(--surface);
  padding: 0 2rem;
  display: flex;
  gap: 0;
  border-bottom: 1px solid var(--border);
  overflow-x: auto;
}
nav button {
  background: none;
  border: none;
  padding: 1rem 1.2rem;
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 600;
  font-size: .9rem;
  color: var(--ink-muted);
  border-bottom: 3px solid transparent;
  transition: all .2s;
  white-space: nowrap;
  display: flex;
  align-items: center;
  gap: .4rem;
}
nav button:hover { color: var(--ink-light); }
nav button.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}
.step-num {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 22px;
  height: 22px;
  border-radius: 50%;
  background: var(--border);
  font-size: .75rem;
  font-weight: 700;
  color: var(--ink-muted);
  transition: all .2s;
}
nav button.active .step-num {
  background: var(--accent);
  color: white;
}

/* ====== MAIN ====== */
main {
  flex: 1;
  max-width: 860px;
  margin: 2rem auto;
  padding: 0 1.5rem;
  width: 100%;
}

section {
  display: none;
  animation: fadeUp .3s ease-out;
}
section.active { display: block; }

@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ====== CARDS ====== */
.card {
  background: var(--surface);
  padding: 2rem;
  border-radius: var(--radius);
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--border-light);
  margin-bottom: 1.5rem;
}
.card-header {
  font-family: var(--font-display);
  font-size: 1.35rem;
  margin-bottom: 1.2rem;
  color: var(--ink);
}

/* ====== FORM ELEMENTS ====== */
label {
  display: block;
  font-weight: 600;
  font-size: .85rem;
  color: var(--ink-light);
  margin-bottom: .4rem;
  text-transform: uppercase;
  letter-spacing: .05em;
}
select, input[type="number"], input[type="password"] {
  width: 100%;
  padding: .75rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  font-family: var(--font-body);
  font-size: .95rem;
  transition: border-color .2s;
  outline: none;
  background: var(--surface);
  color: var(--ink);
}
select:focus, input:focus { border-color: var(--accent); }

.form-group { margin-bottom: 1.2rem; }

/* ====== TASK DISPLAY ====== */
.task-box {
  background: var(--accent-glow);
  border-left: 4px solid var(--accent);
  padding: 1.4rem 1.6rem;
  margin: 1rem 0;
  border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
  line-height: 1.7;
  font-size: .95rem;
  white-space: pre-wrap;
}
.source-text {
  background: var(--bg-warm);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1.6rem;
  margin: 1rem 0;
  line-height: 1.8;
  font-size: .95rem;
  max-height: 500px;
  overflow-y: auto;
}
.source-text p { margin-bottom: .8rem; }
.word-badge {
  display: inline-flex;
  align-items: center;
  gap: .3rem;
  background: var(--border-light);
  padding: .3rem .7rem;
  border-radius: 20px;
  font-size: .8rem;
  font-weight: 600;
  color: var(--ink-muted);
  margin-top: .8rem;
}

/* ====== TEXTAREA ====== */
textarea {
  width: 100%;
  min-height: 380px;
  padding: 1.4rem;
  font-family: var(--font-mono);
  font-size: .92rem;
  line-height: 1.7;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  box-sizing: border-box;
  outline: none;
  transition: border-color .2s;
  resize: vertical;
  color: var(--ink);
}
textarea:focus { border-color: var(--accent); }

.write-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: .8rem;
  flex-wrap: wrap;
  gap: .8rem;
}
.word-counter {
  font-size: .85rem;
  color: var(--ink-muted);
  font-weight: 500;
  font-family: var(--font-mono);
}

/* ====== OCR UPLOAD ====== */
.ocr-section {
  margin-top: 1.5rem;
  padding-top: 1.5rem;
  border-top: 1px solid var(--border);
}
.upload-zone {
  border: 2px dashed var(--border);
  border-radius: var(--radius-sm);
  padding: 2rem;
  text-align: center;
  cursor: pointer;
  transition: all .2s;
  background: var(--bg-warm);
}
.upload-zone:hover {
  border-color: var(--accent);
  background: var(--accent-glow);
}
.upload-zone.dragover {
  border-color: var(--accent);
  background: var(--accent-soft);
}
.upload-icon {
  font-size: 2rem;
  margin-bottom: .5rem;
}
.upload-text {
  font-size: .9rem;
  color: var(--ink-muted);
}
.upload-text strong {
  color: var(--accent);
}
#ocrPreview {
  display: none;
  margin-top: 1rem;
  text-align: center;
}
#ocrPreview img {
  max-width: 100%;
  max-height: 200px;
  border-radius: var(--radius-sm);
  border: 1px solid var(--border);
}

/* ====== OCR MULTI-PAGE ====== */
.ocr-pages {
  display: flex;
  flex-wrap: wrap;
  gap: .6rem;
  margin-top: 1rem;
}
.ocr-page-thumb {
  position: relative;
  width: 90px;
  height: 90px;
  border-radius: var(--radius-sm);
  border: 2px solid var(--border);
  overflow: hidden;
  flex-shrink: 0;
}
.ocr-page-thumb img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
.ocr-page-thumb .page-num {
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(0,0,0,.6);
  color: white;
  font-size: .7rem;
  font-weight: 700;
  text-align: center;
  padding: .15rem;
}
.ocr-page-thumb .remove-page {
  position: absolute;
  top: 2px;
  right: 2px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: rgba(220,38,38,.85);
  color: white;
  border: none;
  font-size: .7rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity .15s;
}
.ocr-page-thumb:hover .remove-page { opacity: 1; }
.ocr-page-thumb.processing {
  border-color: var(--accent);
  animation: pulse 1.5s infinite;
}
.ocr-page-thumb.done { border-color: var(--success); }
.ocr-page-thumb.error { border-color: var(--warning); }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.6} }

/* ====== FEEDBACK / SCORES ====== */
.scores-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.score-card {
  background: var(--bg-warm);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 1.2rem;
  text-align: center;
}
.score-card.total {
  background: var(--accent-glow);
  border-color: var(--accent);
}
.score-label {
  font-size: .75rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .05em;
  color: var(--ink-muted);
  margin-bottom: .3rem;
}
.score-value {
  font-family: var(--font-display);
  font-size: 2rem;
  color: var(--ink);
  line-height: 1;
}
.score-card.total .score-value { color: var(--accent); }
.score-max {
  font-size: .8rem;
  color: var(--ink-muted);
}

.feedback-body {
  line-height: 1.7;
  font-size: .95rem;
}
.feedback-body h1 { font-family: var(--font-display); font-size: 1.4rem; margin: 1.5rem 0 .8rem; }
.feedback-body h2 { font-family: var(--font-display); font-size: 1.15rem; margin: 1.3rem 0 .6rem; color: var(--ink); }
.feedback-body h3 { font-size: 1rem; margin: 1rem 0 .5rem; }
.feedback-body ul, .feedback-body ol { padding-left: 1.5rem; margin: .5rem 0; }
.feedback-body li { margin-bottom: .3rem; }
.feedback-body p { margin-bottom: .6rem; }
.feedback-body strong { color: var(--ink); }
.feedback-body code {
  background: var(--border-light);
  padding: .15rem .4rem;
  border-radius: 4px;
  font-family: var(--font-mono);
  font-size: .85em;
}

/* ====== LOADER ====== */
.loader {
  display: none;
  margin: 2rem auto;
  text-align: center;
}
.loader-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin .8s linear infinite;
  margin: 0 auto .8rem;
}
.loader-text {
  font-size: .85rem;
  color: var(--ink-muted);
  font-weight: 500;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* ====== FOOTER ====== */
footer {
  text-align: center;
  padding: 2rem;
  color: var(--ink-muted);
  font-size: .8rem;
  border-top: 1px solid var(--border);
  margin-top: auto;
}

/* ====== PDF EXPORT ====== */
.pdf-actions {
  display: flex;
  gap: .6rem;
  margin-top: 1.5rem;
  flex-wrap: wrap;
}

/* ====== DARK MODE TOGGLE ====== */
.theme-toggle {
  background: var(--border);
  border: none;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.1rem;
  transition: all .2s;
  flex-shrink: 0;
}
.theme-toggle:hover { background: var(--accent-soft); }

/* ====== TIMER ====== */
.timer-bar {
  display: none;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: .8rem 1.2rem;
  margin-bottom: 1rem;
  align-items: center;
  gap: 1rem;
  flex-wrap: wrap;
}
.timer-bar.active { display: flex; }
.timer-display {
  font-family: var(--font-mono);
  font-size: 1.6rem;
  font-weight: 700;
  color: var(--ink);
  min-width: 80px;
}
.timer-display.warning { color: var(--warning); animation: pulse 1s infinite; }
.timer-label {
  font-size: .8rem;
  color: var(--ink-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: .04em;
}
.timer-controls { display: flex; gap: .4rem; margin-left: auto; }
.timer-controls button {
  background: var(--border);
  border: none;
  padding: .4rem .7rem;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-family: var(--font-body);
  font-size: .8rem;
  font-weight: 600;
  color: var(--ink-light);
  transition: all .15s;
}
.timer-controls button:hover { background: var(--accent-soft); color: var(--accent); }

.timer-setup {
  display: flex;
  align-items: center;
  gap: .8rem;
  flex-wrap: wrap;
}
.timer-setup input[type="number"] {
  width: 70px;
  padding: .4rem .6rem;
  text-align: center;
}

/* ====== PROGRESS TRACKER ====== */
.history-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--ink-muted);
}
.history-empty .empty-icon { font-size: 2.5rem; margin-bottom: .8rem; }

.history-chart {
  width: 100%;
  height: 220px;
  margin: 1rem 0;
}
.history-chart canvas { width: 100% !important; height: 100% !important; }

.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: .88rem;
}
.history-table th {
  text-align: left;
  padding: .6rem .8rem;
  font-size: .75rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: .04em;
  color: var(--ink-muted);
  border-bottom: 2px solid var(--border);
}
.history-table td {
  padding: .6rem .8rem;
  border-bottom: 1px solid var(--border-light);
  color: var(--ink-light);
}
.history-table tr:hover td { background: var(--accent-glow); }
.history-score {
  font-family: var(--font-mono);
  font-weight: 700;
  color: var(--accent);
}
.history-delete {
  background: none;
  border: none;
  cursor: pointer;
  color: var(--ink-muted);
  font-size: .85rem;
  padding: .2rem;
  transition: color .15s;
}
.history-delete:hover { color: var(--warning); }

/* ====== MODE TOGGLE ====== */
.mode-toggle {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: .6rem;
}
.mode-btn {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: .5rem;
  padding: .9rem 1rem;
  border: 2px solid var(--border);
  border-radius: var(--radius-sm);
  background: var(--bg-warm);
  cursor: pointer;
  font-family: var(--font-body);
  font-weight: 600;
  font-size: .9rem;
  color: var(--ink-muted);
  transition: all .2s;
}
.mode-btn:hover {
  border-color: var(--accent);
  color: var(--ink);
}
.mode-btn.active {
  border-color: var(--accent);
  background: var(--accent-glow);
  color: var(--accent);
}

/* ====== RESPONSIVE ====== */
@media (max-width: 640px) {
  header { padding: .8rem 1rem; }
  header h1 { font-size: 1.1rem; }
  nav { padding: 0 .5rem; }
  nav button { padding: .8rem .7rem; font-size: .82rem; }
  main { padding: 0 1rem; margin: 1rem auto; }
  .card { padding: 1.4rem; }
  .scores-grid { grid-template-columns: 1fr; }
  textarea { min-height: 280px; }
  .mode-toggle { grid-template-columns: 1fr; }
}
</style>
</head>

<body>

<!-- ====== LOGIN REDIRECT ====== -->
<div id="login-screen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;">
  <div style="text-align:center;">
    <p style="color:var(--ink-muted);margin-bottom:1rem;">Bitte zuerst √ºber die Startseite einloggen.</p>
    <a href="index.html" style="color:var(--accent);font-weight:600;text-decoration:none;font-size:1.1rem;">‚Üí Zur Startseite</a>
  </div>
</div>

<!-- ====== APP ====== -->
<div id="app-wrapper">

  <header>
    <h1><a href="index.html" style="color:var(--ink);text-decoration:none;">‚Üê</a> Textproduktion <span>Trainer</span></h1>
    <div style="display:flex;align-items:center;gap:.8rem;">
      <span id="studentGreeting" style="display:none;font-size:.85rem;color:var(--ink-muted);font-weight:500;"></span>
      <div class="header-meta">Created by DZ ¬∑ St. Anna</div>
      <button class="theme-toggle" onclick="toggleDarkMode()" title="Dark Mode umschalten" id="themeToggleBtn">üåô</button>
    </div>
  </header>

  <nav>
    <button id="nav-setup" class="active" onclick="nav('setup')">
      <span class="step-num">1</span> Setup
    </button>
    <button id="nav-task" onclick="nav('task')">
      <span class="step-num">2</span> Aufgabe
    </button>
    <button id="nav-write" onclick="nav('write')">
      <span class="step-num">3</span> Schreiben
    </button>
    <button id="nav-feedback" onclick="nav('feedback')">
      <span class="step-num">4</span> Bewertung
    </button>
    <button id="nav-progress" onclick="nav('progress')" style="margin-left:auto;">
      <span class="step-num">üìä</span> Fortschritt
    </button>
  </nav>

  <main>

    <!-- ====== STEP 1: SETUP ====== -->
    <section id="setup" class="active">

      <!-- Mode Toggle -->
      <div class="card">
        <h2 class="card-header">Aufgabe w√§hlen</h2>
        <div class="mode-toggle">
          <button class="mode-btn active" id="modeGenerate" onclick="setSetupMode('generate')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            KI-Aufgabe generieren
          </button>
          <button class="mode-btn" id="modeUpload" onclick="setSetupMode('upload')">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
            Eigene Aufgabe hochladen
          </button>
        </div>
      </div>

      <!-- MODE A: Generate -->
      <div class="card" id="setupGenerate">
        <h2 class="card-header">Neue Aufgabe generieren</h2>
        <p style="color:var(--ink-muted);font-size:.9rem;margin-bottom:1.2rem;">
          Die KI erstellt einen englischen Ausgangstext und drei Aufgaben (Outline, Analyse, Stellungnahme/Gestaltendes Schreiben).
        </p>

        <div class="form-group">
          <label>Themenfeld</label>
          <select id="topicSelect">
            <option value="Science & Technology: Visions of the future, Utopia vs. Dystopia">Science & Technology: Visions of the Future</option>
            <option value="Global Chances and Challenges: Sustainability">Global Chances & Challenges: Sustainability</option>
            <option value="The Media: Impact on individual and society">The Media: Impact on Individual & Society</option>
            <option value="Politics and Society: UK/USA tradition and change">Politics & Society: UK/USA Tradition & Change</option>
            <option value="The World of Work: Automation and Digitalization">The World of Work: Automation & Digitalization</option>
          </select>
        </div>

        <div class="form-group">
          <label>Textart</label>
          <select id="textTypeSelect">
            <option value="nicht-literarisch">Text I ‚Äì nicht-literarisch (Zeitungsartikel, Essay, Feature)</option>
            <option value="literarisch">Text II ‚Äì literarisch (Roman-/Kurzgeschichtenauszug)</option>
          </select>
        </div>

        <button class="btn" id="generateBtn" onclick="generateExam()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          Aufgabe generieren
        </button>

        <div id="setupLoader" class="loader">
          <div class="loader-spinner"></div>
          <div class="loader-text">Aufgabe wird generiert ‚Äì das kann bis zu 30 Sekunden dauern ‚Ä¶</div>
        </div>
      </div>

      <!-- MODE B: Upload own task -->
      <div class="card" id="setupUpload" style="display:none;">
        <h2 class="card-header">Eigene Aufgabe hochladen</h2>
        <p style="color:var(--ink-muted);font-size:.9rem;margin-bottom:1.2rem;">
          Lade Fotos einer Abituraufgabe hoch (z.B. alte Pr√ºfung). Die KI erkennt automatisch
          den deutschen Quelltext und die englische Aufgabenstellung.
        </p>

        <div class="upload-zone" id="taskUploadZone" onclick="document.getElementById('taskFileInput').click()">
          <div class="upload-icon">üìÑ</div>
          <div class="upload-text"><strong>Klicken</strong> oder Bilder hierher ziehen</div>
          <div class="upload-text" style="font-size:.8rem;margin-top:.3rem">JPG, PNG ‚Äì Mehrere Seiten m√∂glich</div>
        </div>

        <input type="file" id="taskFileInput" accept="image/*" multiple style="display:none" onchange="handleTaskUpload(this.files)">

        <div id="taskUploadPages" class="ocr-pages"></div>

        <div id="taskUploadLoader" class="loader">
          <div class="loader-spinner"></div>
          <div class="loader-text">Aufgabe wird erkannt ‚Ä¶</div>
        </div>

        <!-- Editable preview of parsed task -->
        <div id="taskUploadResult" style="display:none;margin-top:1.2rem;">
          <div class="form-group">
            <label>Erkannte Aufgabenstellung (Englisch) ‚Äì bearbeitbar</label>
            <textarea id="parsedTaskInstruction" style="min-height:120px;" placeholder="Englische Aufgabenstellung ‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Erkannter Quelltext (Deutsch) ‚Äì bearbeitbar</label>
            <textarea id="parsedArticleText" style="min-height:200px;" placeholder="Deutscher Quelltext ‚Ä¶"></textarea>
          </div>
          <div class="form-group">
            <label>Titel / √úberschrift</label>
            <input type="text" id="parsedHeadline" placeholder="Titel des Quelltextes ‚Ä¶" style="width:100%;padding:.75rem 1rem;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.95rem;outline:none;">
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
            <button class="btn" onclick="useUploadedTask()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Aufgabe √ºbernehmen
            </button>
            <button class="btn btn-secondary" onclick="clearTaskUpload()">Verwerfen</button>
          </div>
        </div>

        <!-- OR: Manual text entry -->
        <details style="margin-top:1.2rem;">
          <summary style="cursor:pointer;color:var(--accent);font-weight:600;font-size:.9rem;">
            Alternativ: Text manuell eingeben
          </summary>
          <div style="margin-top:1rem;">
            <div class="form-group">
              <label>Aufgabenstellung (Englisch)</label>
              <textarea id="manualTaskInstruction" style="min-height:100px;" placeholder="Write an article on ‚Ä¶"></textarea>
            </div>
            <div class="form-group">
              <label>Quelltext (Deutsch)</label>
              <textarea id="manualArticleText" style="min-height:180px;" placeholder="Deutscher Quelltext hier einf√ºgen ‚Ä¶"></textarea>
            </div>
            <div class="form-group">
              <label>Titel / √úberschrift</label>
              <input type="text" id="manualHeadline" placeholder="Titel ‚Ä¶" style="width:100%;padding:.75rem 1rem;border:2px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font-body);font-size:.95rem;outline:none;">
            </div>
            <button class="btn" onclick="useManualTask()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Aufgabe √ºbernehmen
            </button>
          </div>
        </details>
      </div>

    </section>

    <!-- ====== STEP 2: TASK ====== -->
    <section id="task">
      <div class="card">
        <h2 class="card-header" id="articleTitle">Ausgangstext</h2>
        <div class="source-text" id="articleBody"></div>
        <div style="font-size:.82rem;color:var(--ink-muted);margin-top:.5rem;" id="sourceInfo"></div>
        <div class="word-badge">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3"/><path d="M9 20h6"/><path d="M12 4v16"/></svg>
          <span id="wordCountLabel">0</span> W√∂rter
        </div>
      </div>

      <div class="card">
        <h2 class="card-header">Aufgaben</h2>
        <p style="color:var(--ink-muted);font-size:.88rem;margin-bottom:1rem;">W√§hle die Aufgabe(n), die du bearbeiten m√∂chtest:</p>

        <div style="display:flex;flex-direction:column;gap:.8rem;">
          <label style="display:flex;gap:.6rem;align-items:flex-start;padding:.8rem;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <input type="checkbox" id="doTask1" style="margin-top:.2rem;" checked>
            <div>
              <strong style="color:var(--accent);">Aufgabe 1 (30%)</strong>
              <div style="font-size:.88rem;color:var(--ink-light);margin-top:.2rem;" id="taskInstruction1">‚Äì</div>
            </div>
          </label>

          <label style="display:flex;gap:.6rem;align-items:flex-start;padding:.8rem;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <input type="checkbox" id="doTask2" style="margin-top:.2rem;" checked>
            <div>
              <strong style="color:var(--accent);">Aufgabe 2 (30%)</strong>
              <div style="font-size:.88rem;color:var(--ink-light);margin-top:.2rem;" id="taskInstruction2">‚Äì</div>
            </div>
          </label>

          <label style="display:flex;gap:.6rem;align-items:flex-start;padding:.8rem;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <input type="radio" name="task3" id="doTask31" value="3.1" style="margin-top:.2rem;" checked>
            <div>
              <strong style="color:var(--accent);">Aufgabe 3.1 (40%)</strong> ‚Äì Pers√∂nliche Stellungnahme
              <div style="font-size:.88rem;color:var(--ink-light);margin-top:.2rem;" id="taskInstruction31">‚Äì</div>
            </div>
          </label>

          <label style="display:flex;gap:.6rem;align-items:flex-start;padding:.8rem;border:2px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:all .15s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border)'">
            <input type="radio" name="task3" id="doTask32" value="3.2" style="margin-top:.2rem;">
            <div>
              <strong style="color:var(--accent);">Aufgabe 3.2 (40%)</strong> ‚Äì Gestaltendes Schreiben
              <div style="font-size:.88rem;color:var(--ink-light);margin-top:.2rem;" id="taskInstruction32">‚Äì</div>
            </div>
          </label>
        </div>
      </div>

      <button class="btn" onclick="nav('write')">
        Weiter zum Schreiben ‚Üí
      </button>
    </section>

    <!-- ====== STEP 3: WRITE ====== -->
    <section id="write">
      <!-- Collapsible Task Reference -->
      <details class="card" id="taskReference" style="cursor:pointer;">
        <summary style="font-family:var(--font-display);font-size:1.1rem;font-weight:400;user-select:none;">
          üìã Aufgabenstellung anzeigen
        </summary>
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);">
          <p style="font-weight:600;color:var(--accent);margin-bottom:.5rem;" id="writeTaskInstruction"></p>
          <div style="max-height:300px;overflow-y:auto;font-size:.88rem;color:var(--ink-light);line-height:1.6;padding:.8rem;background:var(--bg-warm);border-radius:var(--radius-sm);" id="writeArticlePreview"></div>
        </div>
      </details>

      <!-- Timer Bar -->
      <div class="timer-bar" id="timerBar">
        <div>
          <div class="timer-label">Verbleibende Zeit</div>
          <div class="timer-display" id="timerDisplay">60:00</div>
        </div>
        <div class="timer-controls">
          <button onclick="pauseTimer()" id="timerPauseBtn">‚è∏ Pause</button>
          <button onclick="stopTimer()">‚úï Stopp</button>
        </div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem;">
          <h2 class="card-header" style="margin-bottom:0">Deine Mediation</h2>
          <!-- Timer Setup (when not running) -->
          <div class="timer-setup" id="timerSetup">
            <label style="margin:0;text-transform:none;font-size:.85rem;letter-spacing:0;">‚è± Pr√ºfungsmodus:</label>
            <input type="number" id="timerMinutes" value="60" min="5" max="180" step="5">
            <span style="font-size:.85rem;color:var(--ink-muted)">Min</span>
            <button class="btn btn-small btn-secondary" onclick="startTimer()">Timer starten</button>
          </div>
        </div>
        <textarea id="studentText" placeholder="Write your mediation here ‚Ä¶" oninput="updateWordCount()"></textarea>

        <div class="write-toolbar">
          <div class="word-counter">
            <span id="currentWordCount">0</span> W√∂rter
          </div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap">
            <button class="btn" id="submitBtn" onclick="submitForCorrection()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
              Zur Bewertung abgeben
            </button>
          </div>
        </div>
      </div>

      <!-- OCR UPLOAD -->
      <div class="card">
        <h2 class="card-header">Handschrift hochladen (OCR)</h2>
        <p style="color:var(--ink-muted);font-size:.9rem;margin-bottom:1rem;">
          Fotos deiner handschriftlichen Mediation hochladen ‚Äì der Text wird automatisch erkannt.
          Du kannst mehrere Seiten nacheinander hinzuf√ºgen.
        </p>

        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('ocrFileInput').click()">
          <div class="upload-icon">üì∑</div>
          <div class="upload-text"><strong>Klicken</strong> oder Bilder hierher ziehen</div>
          <div class="upload-text" style="font-size:.8rem;margin-top:.3rem">JPG, PNG ‚Äì max. 10 MB pro Bild ¬∑ Mehrere Seiten m√∂glich</div>
        </div>

        <input type="file" id="ocrFileInput" accept="image/*" multiple style="display:none" onchange="handleOCRFiles(this.files)">

        <!-- Thumbnail gallery for uploaded pages -->
        <div id="ocrPages" class="ocr-pages"></div>

        <div id="ocrLoader" class="loader">
          <div class="loader-spinner"></div>
          <div class="loader-text">Handschrift wird erkannt ‚Ä¶ <span id="ocrProgress"></span></div>
        </div>

        <div id="ocrResult" style="display:none;margin-top:1rem;">
          <label>Erkannter Text (bearbeitbar):</label>
          <textarea id="ocrText" style="min-height:200px;" placeholder="Erkannter Text erscheint hier ‚Äì du kannst ihn vor der √úbernahme bearbeiten ‚Ä¶"></textarea>
          <div style="display:flex;gap:.5rem;margin-top:.8rem;flex-wrap:wrap;align-items:center;">
            <button class="btn btn-small" onclick="useOCRText()">
              ‚úì Text √ºbernehmen
            </button>
            <button class="btn btn-small btn-secondary" onclick="clearOCR()">
              Verwerfen
            </button>
            <span style="font-size:.8rem;color:var(--ink-muted);margin-left:auto;" id="ocrWordCount"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- ====== STEP 4: FEEDBACK ====== -->
    <section id="feedback">
      <div id="feedbackLoader" class="loader">
        <div class="loader-spinner"></div>
        <div class="loader-text">Bewertung wird erstellt ‚Äì bitte warten ‚Ä¶</div>
      </div>

      <div id="feedbackContent" style="display:none;">
        <!-- Scores Grid -->
        <div class="scores-grid" id="scoresGrid">
          <div class="score-card">
            <div class="score-label">Inhalt & Struktur (40%)</div>
            <div class="score-value" id="scoreContent">‚Äì</div>
            <div class="score-max">von 15 NP</div>
          </div>
          <div class="score-card">
            <div class="score-label">Sprache (60%)</div>
            <div class="score-value" id="scoreLang">‚Äì</div>
            <div class="score-max">von 15 NP</div>
          </div>
          <div class="score-card total">
            <div class="score-label">Gesamt</div>
            <div class="score-value" id="scoreTotal">‚Äì</div>
            <div class="score-max">von 15 NP</div>
          </div>
          <div class="score-card" style="background:var(--accent-glow);border-color:var(--accent);">
            <div class="score-label">Schulnote</div>
            <div class="score-value" id="scoreGrade" style="font-size:1.8rem;">‚Äì</div>
            <div class="score-max" id="scoreGradeLabel"></div>
          </div>
        </div>

        <!-- Detailed Feedback -->
        <div class="card">
          <h2 class="card-header">Detailliertes Feedback</h2>
          <div class="feedback-body" id="feedbackBody"></div>
        </div>

        <!-- Musterl√∂sung -->
        <div class="card" id="modelAnswerCard" style="display:none;">
          <h2 class="card-header">Musterl√∂sung</h2>
          <div class="feedback-body" id="modelAnswerBody"></div>
        </div>

        <!-- Disclaimer -->
        <div style="background:var(--accent-glow);border:1px solid var(--border);border-radius:var(--radius-sm);padding:.8rem 1.2rem;margin-top:1rem;font-size:.82rem;color:var(--ink-muted);line-height:1.5;">
          ‚ö†Ô∏è <strong>Hinweis:</strong> Diese Bewertung wurde von einer KI erstellt und dient als Orientierung f√ºr dein Lernen. Sie ersetzt keine offizielle Lehrerkorrektur. Besprich deine Ergebnisse im Zweifelsfall mit deiner Lehrkraft.
        </div>

        <!-- Actions -->
        <div class="pdf-actions">
          <button class="btn btn-secondary btn-small" onclick="generateModelAnswer()" id="modelAnswerBtn">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
            Musterl√∂sung zeigen
          </button>
          <button class="btn btn-secondary btn-small" onclick="exportPDF()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
            Als PDF exportieren
          </button>
          <button class="btn btn-secondary btn-small" onclick="resetAll()">
            Neue Aufgabe starten
          </button>
        </div>
      </div>
    </section>

    <!-- ====== STEP 5: PROGRESS ====== -->
    <section id="progress">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.5rem;">
          <h2 class="card-header" style="margin-bottom:0">Dein Fortschritt</h2>
          <button class="btn btn-small btn-secondary" onclick="clearHistory()" id="clearHistoryBtn" style="display:none;">
            Verlauf l√∂schen
          </button>
        </div>

        <div id="progressEmpty" class="history-empty">
          <div class="empty-icon">üìà</div>
          <p>Noch keine Ergebnisse vorhanden.</p>
          <p style="font-size:.85rem;">Deine Bewertungen erscheinen hier nach jeder Abgabe.</p>
        </div>

        <div id="progressContent" style="display:none;">
          <div class="history-chart">
            <canvas id="progressChart"></canvas>
          </div>

          <!-- Stats summary -->
          <div class="scores-grid" style="margin:1.5rem 0;">
            <div class="score-card">
              <div class="score-label">Versuche</div>
              <div class="score-value" id="statAttempts">0</div>
            </div>
            <div class="score-card">
              <div class="score-label">Durchschnitt</div>
              <div class="score-value" id="statAverage">‚Äì</div>
              <div class="score-max">von 15 NP</div>
            </div>
            <div class="score-card total">
              <div class="score-label">Bestes Ergebnis</div>
              <div class="score-value" id="statBest">‚Äì</div>
              <div class="score-max">von 15 NP</div>
            </div>
          </div>

          <h3 style="font-family:var(--font-display);margin-bottom:.8rem;">Vergangene Versuche</h3>
          <div style="overflow-x:auto;">
            <table class="history-table">
              <thead>
                <tr>
                  <th>Datum</th>
                  <th>Thema</th>
                  <th>Inhalt</th>
                  <th>Sprache</th>
                  <th>Gesamt</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="historyTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer>
    ¬© 2026 St. Anna Gymnasium ¬∑ Textproduktion Trainer ¬∑ Created by DZ
    <br><a href="index.html" style="color:var(--ink-muted);font-size:.75rem;text-decoration:none;opacity:.6;">‚Üê Zur√ºck zur Startseite</a>
  </footer>

</div>

<script>
/* ================= CONFIG ================= */
const API_BASE = "https://sag-abi-mediation-api.sanktannagymnasium.workers.dev";
const ACCESS_PASSWORD = sessionStorage.getItem("access_password") || "";

const GENERATION_PROMPT_TEMPLATE = `Du bist ein Experte f√ºr das bayerische Abitur im Fach Englisch (Pr√ºfungsteil B: Schreiben). Erstelle eine vollst√§ndige Schreiben-Pr√ºfungsaufgabe.

NIVEAU: {level}
THEMA: {topic}
TEXTART: {texttype}
STRIKTE ZIELL√ÑNGE: ca. 700 W√∂rter

Erstelle einen ENGLISCHEN Ausgangstext UND drei Aufgaben dazu, exakt im Stil des bayerischen Abiturs 2026.

TEIL 1 ‚Äì ENGLISCHER AUSGANGSTEXT:

WENN TEXTART = "nicht-literarisch":
- Schreibe einen authentisch wirkenden englischen Sachtext (Zeitungsartikel, Essay, Feature, Reportage).
- Ca. 700 W√∂rter (Toleranz ¬±10%). Durchg√§ngiger Flie√ütext, sprachlich anspruchsvoll, klare Argumentation.
- Verwende analysierbare Stilmittel (Metaphern, rhetorische Fragen, Ironie, Kontraste etc.).
- Erfinde einen plausiblen Autor und eine Quelle (z.B. "Sarah Mitchell, The Guardian, 15.03.2025").

WENN TEXTART = "literarisch":
- Schreibe einen Auszug aus einem fiktiven englischsprachigen Roman oder einer Kurzgeschichte.
- Ca. 700 W√∂rter. Erz√§hlerischer Text mit Figurenentwicklung, Atmosph√§re, Dialogen.
- Verwende literarische Stilmittel (Bildsprache, Symbolik, Erz√§hlperspektive, Stream of Consciousness, Kontraste, Foreshadowing etc.).
- Gib eine kurze Kontextinfo am Anfang (1-2 S√§tze kursiv, z.B. "The following passage is set in...").
- Erfinde einen plausiblen Autor (z.B. "Emma Whitfield, The Glass Between Us, 2023").

TEIL 2 ‚Äì DREI AUFGABEN:

Aufgabe 1 (30%): Eine kurze, pr√§zise Outline-Aufgabe.
- Bei nicht-literarisch: z.B. "Outline the main arguments presented in the article and the author's stance on [Thema]."
- Bei literarisch: z.B. "Outline what the reader learns about [Figur] and [his/her] state of mind."

Aufgabe 2 (30%): Eine kurze, pr√§zise Analyse-Aufgabe. MAXIMAL 1-2 S√§tze!
- Bei nicht-literarisch: z.B. "Analyse the writer's attitude. Focus on the use of language."
- Bei literarisch: z.B. "Analyse how the setting is used to create atmosphere. Focus on the author's use of language."

Aufgabe 3 (40%): ZWEI Wahlaufgaben (3.1 und 3.2):
- 3.1: Ein Zitat aus dem Text + "Taking the quotation as a starting point, assess/discuss..." (1 Satz)
- 3.2: Situationsbeschreibung (1-2 S√§tze) + "Write a/an [Textsorte] in which you..." (1 Satz)

Bei eA: Aufgaben sprachlich und inhaltlich anspruchsvoller, tiefere Analyse erwartet.
Bei gA: Aufgaben etwas zug√§nglicher formuliert.

OUTPUT FORMAT (NUR reines JSON):
{
  "headline": "Titel des Texts",
  "source_info": "Autor, Quelle, Datum",
  "article_text": "Der komplette englische Text...",
  "task_1": "Outline...",
  "task_2": "Analyse... Focus on...",
  "task_3_1_quote": "Exaktes Zitat aus dem Text (mit Zeilenangabe)",
  "task_3_1": "Taking the quotation as a starting point, assess/discuss...",
  "task_3_2_situation": "Situationsbeschreibung (1-2 S√§tze)",
  "task_3_2": "Write a/an [Textsorte] in which you..."
}`;

const CORRECTION_RUBRIC_PROMPT = `Rolle: Du bist ein erfahrener und strenger Englischlehrer an einem bayerischen Gymnasium. Du bewertest eine Textproduktion (Schreiben) nach dem offiziellen ISB-Bewertungsraster (Stand: Juni 2024).

BEWERTUNGSSYSTEM:
- Inhalt und Textstruktur: 0-15 Notenpunkte (Gewichtung 40%)
- Sprache: 0-15 Notenpunkte (Gewichtung 60%)
- Gesamtnote: gewichteter Durchschnitt, gerundet (0-15 NP)
- SPERRKLAUSEL: Inhalt ODER Sprache = 0 NP -> Gesamt max. 3 NP.

=== WICHTIG: W√ÑHLE DAS RICHTIGE INHALTSRASTER JE NACH AUFGABENTYP ===

Wenn der Sch√ºler Aufgabe 1 (Outline) oder Aufgabe 2 (Analyse) bearbeitet hat, verwende RASTER A.
Wenn der Sch√ºler Aufgabe 3.1 (Stellungnahme) oder 3.2 (Gestaltendes Schreiben) bearbeitet hat, verwende RASTER B.
Falls der Sch√ºler mehrere Aufgaben bearbeitet hat, bewerte jede nach dem passenden Raster und bilde einen Gesamteindruck.

=== RASTER A: TEXTVERSTEHEN UND TEXTANALYSE ‚Äì Inhalt (40%) ===
(F√ºr Aufgabe 1: Outline und Aufgabe 2: Analyse)

15-13 NP: Aufgabenstellung vollumf√§nglich erf√ºllt, Textaussage vollumf√§nglich erfasst. Durchgehend text- und sachbezogene, differenzierte Umsetzung. Durchg√§ngig koh√§rente, klar strukturierte und sehr √ºberzeugende Darstellung.

12-10 NP: Nahezu vollst√§ndig erf√ºllt, Textaussage erfasst; vereinzelte L√ºcken fallen nicht ins Gewicht. Meist text- und sachbezogene, differenzierte Umsetzung. Meist koh√§rente, strukturierte und √ºberzeugende Darstellung.

09-07 NP: Im Gro√üen und Ganzen erf√ºllt, Textaussage im Allgemeinen erfasst; einzelne L√ºcken vorhanden. In weiten Teilen text- und sachbezogen, differenziert. Weitgehend koh√§rent, im Gro√üen und Ganzen √ºberzeugend.

06-04 NP: Insgesamt noch erf√ºllt, Textaussage insgesamt noch erfasst; mehrere L√ºcken vorhanden. Mit Abstrichen noch text- und sachbezogen. Ansatzweise koh√§rent, nur teilweise √ºberzeugend.

03-01 NP: Kaum mehr erf√ºllt und/oder Textaussage kaum mehr erfasst; gr√∂√üere L√ºcken. Kaum noch text- und sachbezogen. Kaum koh√§rent, in weiten Teilen unstrukturiert.

00 NP: Nicht erf√ºllt und/oder Textaussage nicht erfasst. Keine text- und sachbezogene Umsetzung. Inkoh√§rent, unstrukturiert, nicht nachvollziehbar.

=== RASTER B: PERS√ñNLICHE STELLUNGNAHME / GESTALTENDES SCHREIBEN ‚Äì Inhalt (40%) ===
(F√ºr Aufgabe 3.1 und 3.2)

15-13 NP: Aufgabenstellung vollumf√§nglich erf√ºllt. Durchgehend sachgerechte, differenzierte und ideenreiche Umsetzung. Textart/Textsorte vollumf√§nglich erf√ºllt, durchg√§ngig treffender Situations-/Adressatenbezug. Durchg√§ngig koh√§rente, klar strukturierte und sehr √ºberzeugende Darstellung.

12-10 NP: Nahezu vollst√§ndig erf√ºllt. Meist sachgerechte, differenzierte und ideenreiche Umsetzung. Textart nahezu vollst√§ndig erf√ºllt, weitgehend treffender Bezug. Meist koh√§rente, √ºberzeugende Darstellung.

09-07 NP: Im Gro√üen und Ganzen erf√ºllt. In weiten Teilen sachgerecht, allenfalls leichte Abweichungen. Textart im Wesentlichen erf√ºllt. Weitgehend koh√§rent und im Gro√üen und Ganzen √ºberzeugend.

06-04 NP: Insgesamt noch erf√ºllt. Mit Abstrichen noch sachgerecht, vereinzelte Abweichungen. Textart mit Abstrichen noch erf√ºllt, ansatzweise Bezug. Ansatzweise koh√§rent, nur teilweise √ºberzeugend.

03-01 NP: Kaum mehr erf√ºllt. Kaum sachgerecht, mehrfache Abweichungen. Textart kaum erf√ºllt, fehlerhafter Bezug. Kaum koh√§rent, in weiten Teilen unstrukturiert.

00 NP: Nicht erf√ºllt. Themaverfehlung. Textart nicht erf√ºllt. Inkoh√§rent, unstrukturiert, nicht nachvollziehbar.

=== SPRACHE (60%) ===

15-13 NP: Lexikalisch, grammatisch, orthographisch in hohem Ma√ü korrekt. Durchgehend eigenst√§ndige Formulierungen. Besonders pr√§zise, differenzierte, idiomatische Wortwahl. Durchg√§ngig variabler, funktionaler Satzbau mit komplexen Strukturen. Breites Spektrum textstrukturierender Mittel.

12-10 NP: √úberwiegend korrekt, keine Beeintr√§chtigung der Verst√§ndlichkeit. Meist eigenst√§ndig. Pr√§zise, meist differenziert und idiomatisch. Meist variabel mit √ºberwiegend angemessenen komplexen Strukturen.

09-07 NP: Im Wesentlichen korrekt, Verst√§ndlichkeit geringf√ºgig eingeschr√§nkt. Teilweise eigenst√§ndig. Treffend, im Allgemeinen differenziert. Teilweise variabel, im Gro√üen und Ganzen angemessen komplex.

06-04 NP: Verst√∂√üe gegen Sprachrichtigkeit, Verst√§ndlichkeit stellenweise beeintr√§chtigt. Noch eigenst√§ndige Anteile. Noch angemessene Wortwahl, eingeschr√§nkter Wortschatz. Wenig variabel, seltene komplexe Strukturen.

03-01 NP: H√§ufung von Verst√∂√üen, Verst√§ndlichkeit stark beeintr√§chtigt. Kaum eigenst√§ndig. Deutlich eingeschr√§nkter Wortschatz. Sehr einfacher, teilweise sprachuntypischer Satzbau.

00 NP: H√§ufung elementarer Verst√∂√üe, Verst√§ndlichkeit nicht mehr gegeben. Keine eigenst√§ndigen Formulierungen. Erhebliche Wortschatzl√ºcken. Einfachste Satzmuster.

=== FORMAT DES FEEDBACKS ===

### Inhalt & Textstruktur ({inhalt_np}/15 NP)
Erkl√§re, ob und wie gut die Aufgabenstellung erf√ºllt wurde. Zitiere konkrete Passagen.

### Sprache ({sprache_np}/15 NP)
Liste Sprachfehler auf: "Fehler" -> "Korrektur" (Erkl√§rung). Gehe auf Korrektheit, Eigenst√§ndigkeit, Wortwahl, Satzbau und textstrukturierende Mittel ein.

### Positive Aspekte
2-3 gelungene Formulierungen oder Argumente (mit Zitat).

WICHTIG: Nenne KEINE Gesamtpunktzahl und KEINE Schulnote im Feedback.
Schreibe auf DEUTSCH, zitiere Sch√ºlertext auf Englisch.`;

const CONFIG = { storedData: {} };

/* ================= API HELPER (sends auth header) ================= */
async function apiCall(endpoint, body) {
  const res = await fetch(API_BASE + endpoint, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "X-Access-Password": ACCESS_PASSWORD
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const errData = await res.json().catch(() => ({}));
    throw new Error(errData.error || `Serverfehler (${res.status})`);
  }
  return res.json();
}

/* ================= LOGIN ================= */
/* ================= LOGIN (session-based from index.html) ================= */
function checkPassword() {
  // Redirect to main login
  window.location.href = "index.html";
}

/* ================= SESSION RECOVERY ================= */
function saveSession() {
  const session = {
    examData: CONFIG.storedData,
    studentText: document.getElementById("studentText").value,
    currentStep: document.querySelector("section.active")?.id || "setup",
    timerSeconds: timerSeconds,
    timerRunning: !!timerInterval
  };
  localStorage.setItem("session_" + getStudentKey(), JSON.stringify(session));
}

function restoreSession() {
  try {
    const raw = localStorage.getItem("session_" + getStudentKey());
    if (!raw) return false;
    const session = JSON.parse(raw);

    if (session.examData && session.examData.article_text) {
      CONFIG.storedData = session.examData;
      renderExam(session.examData);
    }
    if (session.studentText) {
      document.getElementById("studentText").value = session.studentText;
      updateWordCount();
    }
    if (session.currentStep && session.currentStep !== "setup") {
      nav(session.currentStep);
    }
    return true;
  } catch { return false; }
}

function getStudentKey() {
  const name = sessionStorage.getItem("student_name") || "default";
  return name.toLowerCase().replace(/\s+/g, "_");
}

/* ================= INIT ================= */
window.onload = function () {
  initTheme();

  // Check session ‚Äì redirect to login if not authenticated
  if (sessionStorage.getItem("access") !== "1" || !sessionStorage.getItem("student_name")) {
    document.getElementById("login-screen").style.display = "flex";
    document.getElementById("app-wrapper").style.display = "none";
    return;
  }

  // Restore login display
  document.getElementById("login-screen").style.display = "none";
  document.getElementById("app-wrapper").style.display = "flex";
  const name = sessionStorage.getItem("student_name") || "";
  const course = sessionStorage.getItem("student_course") || "";
  const level = (sessionStorage.getItem("student_level") || "").toUpperCase();
  document.getElementById("studentGreeting").textContent = [name, course, level].filter(Boolean).join(" ¬∑ ");
  document.getElementById("studentGreeting").style.display = "inline";

  // Restore session
  restoreSession();

  // Auto-save session every 15 seconds
  setInterval(saveSession, 15000);
};

/* ================= GENERATE ================= */
async function generateExam() {
  const topic = document.getElementById("topicSelect").value;
  const textType = document.getElementById("textTypeSelect").value;
  const level = sessionStorage.getItem("student_level") || "gA";
  const btn = document.getElementById("generateBtn");

  btn.disabled = true;
  document.getElementById("setupLoader").style.display = "block";

  try {
    // Build prompt with level and text type substituted
    const prompt = GENERATION_PROMPT_TEMPLATE
      .replace(/\{level\}/g, level === "eA" ? "erh√∂htes Anforderungsniveau (eA)" : "grundlegendes Anforderungsniveau (gA)")
      .replace(/\{texttype\}/g, textType);

    const data = await apiCall("/api/generate", {
      topic,
      source_len_words: 700,
      prompt_template: prompt
    });

    CONFIG.storedData = data;
    localStorage.setItem("exam_data", JSON.stringify(data));
    renderExam(data);
    nav("task");
  } catch (e) {
    alert("Fehler beim Generieren: " + e.message);
  }

  btn.disabled = false;
  document.getElementById("setupLoader").style.display = "none";
}

/* ================= SETUP MODE TOGGLE ================= */
function setSetupMode(mode) {
  document.getElementById("modeGenerate").classList.toggle("active", mode === "generate");
  document.getElementById("modeUpload").classList.toggle("active", mode === "upload");
  document.getElementById("setupGenerate").style.display = mode === "generate" ? "block" : "none";
  document.getElementById("setupUpload").style.display = mode === "upload" ? "block" : "none";
}

/* ================= TASK UPLOAD (own exam) ================= */
const taskUploadImages = []; // {file, url, base64}

async function handleTaskUpload(fileList) {
  const files = Array.from(fileList).filter(f => {
    if (!f.type.startsWith("image/")) return false;
    if (f.size > 10 * 1024 * 1024) { alert(`${f.name} zu gro√ü (max. 10 MB).`); return false; }
    return true;
  });
  if (!files.length) return;

  for (const file of files) {
    const url = URL.createObjectURL(file);
    taskUploadImages.push({ file, url, base64: null, status: "pending" });
  }
  renderTaskUploadPages();

  // Convert all to base64
  const startIdx = taskUploadImages.length - files.length;
  for (let i = startIdx; i < taskUploadImages.length; i++) {
    taskUploadImages[i].base64 = await fileToBase64(taskUploadImages[i].file);
    taskUploadImages[i].status = "done";
    renderTaskUploadPages();
  }

  // Now parse all images via API
  document.getElementById("taskUploadLoader").style.display = "block";
  document.getElementById("taskUploadResult").style.display = "none";

  try {
    const base64List = taskUploadImages.map(p => p.base64).filter(Boolean);
    const data = await apiCall("/api/parse-task", { images: base64List });

    document.getElementById("parsedTaskInstruction").value = data.task_instruction || "";
    document.getElementById("parsedArticleText").value = data.article_text || "";
    document.getElementById("parsedHeadline").value = data.headline || "";
    document.getElementById("taskUploadResult").style.display = "block";
  } catch (e) {
    alert("Fehler bei der Erkennung: " + e.message);
  }

  document.getElementById("taskUploadLoader").style.display = "none";
  document.getElementById("taskFileInput").value = "";
}

function renderTaskUploadPages() {
  const container = document.getElementById("taskUploadPages");
  if (!taskUploadImages.length) { container.innerHTML = ""; return; }
  container.innerHTML = taskUploadImages.map((p, i) => `
    <div class="ocr-page-thumb ${p.status}">
      <img src="${p.url}" alt="Seite ${i + 1}">
      <div class="page-num">Seite ${i + 1}</div>
      <button class="remove-page" onclick="removeTaskPage(${i})" title="Entfernen">‚úï</button>
    </div>
  `).join("");
}

function removeTaskPage(index) {
  URL.revokeObjectURL(taskUploadImages[index].url);
  taskUploadImages.splice(index, 1);
  renderTaskUploadPages();
}

function useUploadedTask() {
  const task = document.getElementById("parsedTaskInstruction").value.trim();
  const article = document.getElementById("parsedArticleText").value.trim();
  const headline = document.getElementById("parsedHeadline").value.trim();

  if (!task && !article) {
    alert("Kein Text erkannt. Bitte pr√ºfe die Bilder oder gib den Text manuell ein.");
    return;
  }

  const content = {
    headline: headline || "Eigene Aufgabe",
    article_text: article,
    task_instruction: task
  };
  CONFIG.storedData = content;
  localStorage.setItem("exam_data", JSON.stringify(content));
  renderExam(content);
  nav("task");
}

function useManualTask() {
  const task = document.getElementById("manualTaskInstruction").value.trim();
  const article = document.getElementById("manualArticleText").value.trim();
  const headline = document.getElementById("manualHeadline").value.trim();

  if (!task && !article) {
    alert("Bitte mindestens Aufgabenstellung oder Quelltext eingeben.");
    return;
  }

  const content = {
    headline: headline || "Eigene Aufgabe",
    article_text: article,
    task_instruction: task
  };
  CONFIG.storedData = content;
  localStorage.setItem("exam_data", JSON.stringify(content));
  renderExam(content);
  nav("task");
}

function clearTaskUpload() {
  taskUploadImages.forEach(p => URL.revokeObjectURL(p.url));
  taskUploadImages.length = 0;
  renderTaskUploadPages();
  document.getElementById("parsedTaskInstruction").value = "";
  document.getElementById("parsedArticleText").value = "";
  document.getElementById("parsedHeadline").value = "";
  document.getElementById("taskUploadResult").style.display = "none";
  document.getElementById("taskFileInput").value = "";
}

// Drag & Drop for task upload zone
document.addEventListener("DOMContentLoaded", () => {
  const zone = document.getElementById("taskUploadZone");
  if (!zone) return;
  zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
  zone.addEventListener("drop", e => {
    e.preventDefault();
    zone.classList.remove("dragover");
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
    if (files.length) handleTaskUpload(files);
  });
});

/* ================= RENDER ================= */
function renderExam(d) {
  document.getElementById("articleTitle").innerText = d.headline || "Ausgangstext";
  document.getElementById("articleBody").innerHTML =
    (d.article_text || "").split("\n").filter(p => p.trim()).map(p => `<p>${escapeHtml(p)}</p>`).join("");
  document.getElementById("wordCountLabel").innerText = countWords(d.article_text || "");
  if (d.source_info) {
    document.getElementById("sourceInfo").innerText = d.source_info;
  }

  // Populate task displays
  document.getElementById("taskInstruction1").innerText = d.task_1 || "‚Äì";
  document.getElementById("taskInstruction2").innerText = d.task_2 || "‚Äì";

  const q31 = d.task_3_1_quote ? `"${d.task_3_1_quote}"\n\n` : "";
  document.getElementById("taskInstruction31").innerText = q31 + (d.task_3_1 || "‚Äì");
  const sit32 = d.task_3_2_situation ? `${d.task_3_2_situation}\n\n` : "";
  document.getElementById("taskInstruction32").innerText = sit32 + (d.task_3_2 || "‚Äì");

  // Populate write-tab reference panel
  const selectedTasks = getSelectedTasks();
  document.getElementById("writeTaskInstruction").innerText = selectedTasks;
  document.getElementById("writeArticlePreview").innerHTML =
    `<strong>${escapeHtml(d.headline || "")}</strong><br><br>` +
    (d.article_text || "").split("\n").filter(p => p.trim()).map(p => `<p>${escapeHtml(p)}</p>`).join("");
}

function getSelectedTasks() {
  const d = CONFIG.storedData;
  let tasks = [];
  if (document.getElementById("doTask1")?.checked) tasks.push("1. " + (d.task_1 || ""));
  if (document.getElementById("doTask2")?.checked) tasks.push("2. " + (d.task_2 || ""));
  if (document.getElementById("doTask31")?.checked) {
    const q = d.task_3_1_quote ? `"${d.task_3_1_quote}" ‚Äî ` : "";
    tasks.push("3.1 " + q + (d.task_3_1 || ""));
  } else if (document.getElementById("doTask32")?.checked) {
    const s = d.task_3_2_situation ? d.task_3_2_situation + " " : "";
    tasks.push("3.2 " + s + (d.task_3_2 || ""));
  }
  return tasks.join("\n\n");
}

/* ================= SUBMIT FOR GRADING ================= */
async function submitForCorrection() {
  const text = document.getElementById("studentText").value;
  if (countWords(text) < 30) {
    alert("Dein Text ist zu kurz (mindestens 30 W√∂rter).");
    return;
  }
  if (!CONFIG.storedData?.article_text || !CONFIG.storedData?.task_instruction) {
    alert("Bitte zuerst eine Pr√ºfung generieren (Schritt 1).");
    return;
  }

  const btn = document.getElementById("submitBtn");
  btn.disabled = true;
  nav("feedback");
  document.getElementById("feedbackLoader").style.display = "block";
  document.getElementById("feedbackContent").style.display = "none";

  try {
    const data = await apiCall("/api/grade", {
      source_text_de: CONFIG.storedData.article_text,
      task_en: getSelectedTasks(),
      student_text_en: text,
      rubric_prompt: CORRECTION_RUBRIC_PROMPT
    });

    // Display scores
    const cs = data.scores?.content_textstructure;
    const ls = data.scores?.language;
    const ts = data.scores?.total;

    document.getElementById("scoreContent").textContent = cs != null ? cs : "‚Äì";
    document.getElementById("scoreLang").textContent = ls != null ? ls : "‚Äì";
    document.getElementById("scoreTotal").textContent = ts != null ? ts : "‚Äì";

    // Calculate and display school grade
    if (ts != null) {
      const grade = npToGrade(ts);
      document.getElementById("scoreGrade").textContent = grade.note;
      document.getElementById("scoreGradeLabel").textContent = grade.label;
    }

    // Save to history (local)
    saveToHistory({
      topic: CONFIG.storedData.headline || document.getElementById("topicSelect")?.value || "‚Äî",
      content: cs,
      language: ls,
      total: ts
    });

    // Save to server (for teacher dashboard) ‚Äì fire and forget
    apiCall("/api/submit-result", {
      student_name: sessionStorage.getItem("student_name") || "Unbekannt",
      course: sessionStorage.getItem("student_course") || "",
      type: "writing",
      topic: CONFIG.storedData.headline || "‚Äî",
      content: cs,
      language: ls,
      total: ts,
      date: new Date().toISOString()
    }).catch(() => {}); // silently fail if server unavailable

    // Stop timer if running
    stopTimer();

    // Display feedback
    const feedbackMd = (data.feedback || "") + (data.corrections ? "\n\n## Korrekturen\n" + data.corrections : "");
    document.getElementById("feedbackBody").innerHTML = safeMarkdown(feedbackMd);

    document.getElementById("feedbackContent").style.display = "block";
  } catch (e) {
    document.getElementById("feedbackContent").style.display = "block";
    document.getElementById("feedbackBody").innerHTML =
      `<p style="color:var(--warning);font-weight:600;">Fehler: ${escapeHtml(e.message)}</p>
       <p style="color:var(--ink-muted);font-size:.9rem;">Bitte versuche es erneut oder kontaktiere deinen Lehrer.</p>`;
  }

  document.getElementById("feedbackLoader").style.display = "none";
  btn.disabled = false;
}

/* ================= OCR (Multi-Page) ================= */
const ocrPages = []; // {file, base64, text, status}

async function handleOCRFiles(fileList) {
  const files = Array.from(fileList);
  const valid = files.filter(f => {
    if (!f.type.startsWith("image/")) { alert(`${f.name} ist kein Bild.`); return false; }
    if (f.size > 10 * 1024 * 1024) { alert(`${f.name} ist zu gro√ü (max. 10 MB).`); return false; }
    return true;
  });
  if (!valid.length) return;

  // Add pages
  for (const file of valid) {
    const url = URL.createObjectURL(file);
    ocrPages.push({ file, url, base64: null, text: "", status: "pending" });
  }
  renderOCRPages();

  // Process each new page
  const startIdx = ocrPages.length - valid.length;
  document.getElementById("ocrLoader").style.display = "block";

  for (let i = startIdx; i < ocrPages.length; i++) {
    const page = ocrPages[i];
    page.status = "processing";
    renderOCRPages();
    document.getElementById("ocrProgress").textContent = `Seite ${i + 1} von ${ocrPages.length}`;

    try {
      const base64 = await fileToBase64(page.file);
      page.base64 = base64;

      const data = await apiCall("/api/ocr", { image_base64: base64 });

      page.text = data.text || "";
      page.status = "done";
    } catch (e) {
      page.text = `[Fehler bei Seite ${i + 1}: ${e.message}]`;
      page.status = "error";
    }
    renderOCRPages();
  }

  document.getElementById("ocrLoader").style.display = "none";
  document.getElementById("ocrProgress").textContent = "";

  // Combine all texts and show result
  combineOCRTexts();
  document.getElementById("ocrResult").style.display = "block";

  // Reset file input so same files can be re-selected
  document.getElementById("ocrFileInput").value = "";
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = () => reject(new Error("Datei konnte nicht gelesen werden"));
    reader.readAsDataURL(file);
  });
}

function renderOCRPages() {
  const container = document.getElementById("ocrPages");
  if (!ocrPages.length) { container.innerHTML = ""; return; }

  container.innerHTML = ocrPages.map((p, i) => `
    <div class="ocr-page-thumb ${p.status}">
      <img src="${p.url}" alt="Seite ${i + 1}">
      <div class="page-num">Seite ${i + 1}</div>
      <button class="remove-page" onclick="removeOCRPage(${i})" title="Entfernen">‚úï</button>
    </div>
  `).join("");
}

function removeOCRPage(index) {
  URL.revokeObjectURL(ocrPages[index].url);
  ocrPages.splice(index, 1);
  renderOCRPages();
  if (ocrPages.length) {
    combineOCRTexts();
  } else {
    document.getElementById("ocrResult").style.display = "none";
  }
}

function combineOCRTexts() {
  const combined = ocrPages
    .map((p, i) => ocrPages.length > 1 ? `--- Seite ${i + 1} ---\n${p.text}` : p.text)
    .join("\n\n");
  document.getElementById("ocrText").value = combined;
  updateOCRWordCount();
}

function updateOCRWordCount() {
  const text = document.getElementById("ocrText").value;
  const count = countWords(text);
  document.getElementById("ocrWordCount").textContent = `${count} W√∂rter erkannt`;
}

// Make OCR textarea editable ‚Äì update word count on input
document.addEventListener("DOMContentLoaded", () => {
  const ocrTextarea = document.getElementById("ocrText");
  if (ocrTextarea) {
    ocrTextarea.addEventListener("input", updateOCRWordCount);
  }
});

function useOCRText() {
  const text = document.getElementById("ocrText").value;
  if (!text.trim()) { alert("Kein Text vorhanden."); return; }

  // Clean up page separators if present
  const cleaned = text.replace(/---\s*Seite\s*\d+\s*---\n?/g, "").trim();
  document.getElementById("studentText").value = cleaned;
  updateWordCount();
  document.getElementById("studentText").scrollIntoView({ behavior: "smooth" });
}

function clearOCR() {
  ocrPages.forEach(p => URL.revokeObjectURL(p.url));
  ocrPages.length = 0;
  renderOCRPages();
  document.getElementById("ocrText").value = "";
  document.getElementById("ocrResult").style.display = "none";
  document.getElementById("ocrFileInput").value = "";
}

// Drag & Drop (multi-file)
document.addEventListener("DOMContentLoaded", () => {
  const zone = document.getElementById("uploadZone");
  if (!zone) return;
  zone.addEventListener("dragover", e => { e.preventDefault(); zone.classList.add("dragover"); });
  zone.addEventListener("dragleave", () => zone.classList.remove("dragover"));
  zone.addEventListener("drop", e => {
    e.preventDefault();
    zone.classList.remove("dragover");
    const files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith("image/"));
    if (files.length) handleOCRFiles(files);
  });
});

/* ================= PDF EXPORT ================= */
function exportPDF() {
  const content = document.getElementById("feedbackContent");
  if (!content) return;

  const opt = {
    margin: [10, 10, 10, 10],
    filename: "Mediation_Bewertung.pdf",
    image: { type: "jpeg", quality: 0.98 },
    html2pdf: { breakBefore: ".card" },
    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
  };

  html2pdf().set(opt).from(content).save();
}

/* ================= RESET ================= */
function resetAll() {
  if (!confirm("Neue Aufgabe starten? Alle aktuellen Daten werden gel√∂scht.")) return;
  localStorage.removeItem("exam_data");
  localStorage.removeItem("student_text");
  localStorage.removeItem("session_" + getStudentKey());
  CONFIG.storedData = {};
  document.getElementById("studentText").value = "";
  document.getElementById("feedbackContent").style.display = "none";
  document.getElementById("modelAnswerCard").style.display = "none";
  document.getElementById("taskInstruction").innerText = "Bitte zuerst eine Pr√ºfung generieren.";
  document.getElementById("articleTitle").innerText = "Quelltext";
  document.getElementById("articleBody").innerHTML = "";
  document.getElementById("wordCountLabel").innerText = "0";
  clearOCR();
  clearTaskUpload();
  stopTimer();
  setSetupMode("generate");
  updateWordCount();
  nav("setup");
}

/* ================= UTILS ================= */
function updateWordCount() {
  const t = document.getElementById("studentText").value;
  localStorage.setItem("student_text", t);
  document.getElementById("currentWordCount").innerText = countWords(t);
}

function countWords(s) {
  return (s || "").trim().split(/\s+/).filter(a => a).length;
}

function npToGrade(np) {
  if (np >= 15) return { note: "1+", label: "sehr gut" };
  if (np >= 14) return { note: "1", label: "sehr gut" };
  if (np >= 13) return { note: "1‚Äì", label: "sehr gut" };
  if (np >= 12) return { note: "2+", label: "gut" };
  if (np >= 11) return { note: "2", label: "gut" };
  if (np >= 10) return { note: "2‚Äì", label: "gut" };
  if (np >= 9)  return { note: "3+", label: "befriedigend" };
  if (np >= 8)  return { note: "3", label: "befriedigend" };
  if (np >= 7)  return { note: "3‚Äì", label: "befriedigend" };
  if (np >= 6)  return { note: "4+", label: "ausreichend" };
  if (np >= 5)  return { note: "4", label: "ausreichend" };
  if (np >= 4)  return { note: "4‚Äì", label: "ausreichend" };
  if (np >= 3)  return { note: "5+", label: "mangelhaft" };
  if (np >= 2)  return { note: "5", label: "mangelhaft" };
  if (np >= 1)  return { note: "5‚Äì", label: "mangelhaft" };
  return { note: "6", label: "ungen√ºgend" };
}

function nav(id) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.querySelectorAll("nav button").forEach(b => b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  const navBtn = document.getElementById("nav-" + id);
  if (navBtn) navBtn.classList.add("active");
  window.scrollTo({ top: 0, behavior: "smooth" });
  if (id === "progress") renderProgress();
}

function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, m => ({
    "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
  }[m]));
}

function safeMarkdown(str) {
  return DOMPurify.sanitize(marked.parse(str));
}

/* ================= MUSTERL√ñSUNG ================= */
async function generateModelAnswer() {
  const btn = document.getElementById("modelAnswerBtn");
  const card = document.getElementById("modelAnswerCard");
  const body = document.getElementById("modelAnswerBody");

  if (card.style.display === "block") {
    // Already visible ‚Äì just scroll to it
    card.scrollIntoView({ behavior: "smooth" });
    return;
  }

  if (!CONFIG.storedData.article_text || !CONFIG.storedData.task_instruction) {
    alert("Keine Aufgabe vorhanden.");
    return;
  }

  btn.disabled = true;
  btn.textContent = "‚è≥ Wird generiert ‚Ä¶";

  try {
    const data = await apiCall("/api/model-answer", {
      source_text_de: CONFIG.storedData.article_text,
      task_en: CONFIG.storedData.task_instruction
    });

    body.innerHTML = safeMarkdown(data.model_answer || "Keine Musterl√∂sung generiert.");
    card.style.display = "block";
    card.scrollIntoView({ behavior: "smooth" });
  } catch (e) {
    body.innerHTML = `<p style="color:var(--warning);">Fehler: ${escapeHtml(e.message)}</p>`;
    card.style.display = "block";
  }

  btn.disabled = false;
  btn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg> Musterl√∂sung zeigen`;
}

/* ================= DARK MODE ================= */
function toggleDarkMode() {
  const html = document.documentElement;
  const isDark = html.getAttribute("data-theme") === "dark";
  html.setAttribute("data-theme", isDark ? "light" : "dark");
  localStorage.setItem("theme", isDark ? "light" : "dark");
  document.getElementById("themeToggleBtn").textContent = isDark ? "üåô" : "‚òÄÔ∏è";
  // Update chart colors if chart exists
  if (progressChartInstance) renderProgressChart();
}

function initTheme() {
  const saved = localStorage.getItem("theme");
  const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
  const theme = saved || (prefersDark ? "dark" : "light");
  document.documentElement.setAttribute("data-theme", theme);
  document.getElementById("themeToggleBtn").textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
}

/* ================= TIMER ================= */
let timerInterval = null;
let timerSeconds = 0;
let timerPaused = false;

function startTimer() {
  const minutes = parseInt(document.getElementById("timerMinutes").value) || 60;
  timerSeconds = minutes * 60;
  timerPaused = false;

  document.getElementById("timerBar").classList.add("active");
  document.getElementById("timerSetup").style.display = "none";
  updateTimerDisplay();

  timerInterval = setInterval(() => {
    if (timerPaused) return;
    timerSeconds--;
    updateTimerDisplay();

    if (timerSeconds <= 0) {
      clearInterval(timerInterval);
      timerInterval = null;
      document.getElementById("timerDisplay").textContent = "00:00";
      document.getElementById("timerDisplay").classList.add("warning");
      alert("‚è∞ Die Zeit ist abgelaufen! Du kannst deinen Text trotzdem noch abgeben.");
    }
  }, 1000);
}

function pauseTimer() {
  timerPaused = !timerPaused;
  document.getElementById("timerPauseBtn").textContent = timerPaused ? "‚ñ∂ Weiter" : "‚è∏ Pause";
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
  timerSeconds = 0;
  timerPaused = false;
  document.getElementById("timerBar").classList.remove("active");
  document.getElementById("timerSetup").style.display = "flex";
  document.getElementById("timerDisplay").classList.remove("warning");
  document.getElementById("timerPauseBtn").textContent = "‚è∏ Pause";
}

function updateTimerDisplay() {
  const m = Math.floor(timerSeconds / 60);
  const s = timerSeconds % 60;
  const display = document.getElementById("timerDisplay");
  display.textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;

  // Warning when under 5 minutes
  if (timerSeconds <= 300 && timerSeconds > 0) {
    display.classList.add("warning");
  } else if (timerSeconds > 300) {
    display.classList.remove("warning");
  }
}

/* ================= PROGRESS TRACKER ================= */
let progressChartInstance = null;

function getHistory() {
  try {
    const key = "mediation_history_" + getStudentKey();
    return JSON.parse(localStorage.getItem(key) || "[]");
  } catch { return []; }
}

function saveToHistory(entry) {
  const history = getHistory();
  history.push({
    date: new Date().toISOString(),
    topic: entry.topic || "‚Äî",
    content: entry.content,
    language: entry.language,
    total: entry.total
  });
  const key = "mediation_history_" + getStudentKey();
  localStorage.setItem(key, JSON.stringify(history));
}

function deleteHistoryEntry(index) {
  const history = getHistory();
  history.splice(index, 1);
  const key = "mediation_history_" + getStudentKey();
  localStorage.setItem(key, JSON.stringify(history));
  renderProgress();
}

function clearHistory() {
  if (!confirm("Gesamten Fortschritt l√∂schen?")) return;
  const key = "mediation_history_" + getStudentKey();
  localStorage.removeItem(key);
  renderProgress();
}

function renderProgress() {
  const history = getHistory();
  const empty = document.getElementById("progressEmpty");
  const content = document.getElementById("progressContent");
  const clearBtn = document.getElementById("clearHistoryBtn");

  if (!history.length) {
    empty.style.display = "block";
    content.style.display = "none";
    clearBtn.style.display = "none";
    return;
  }

  empty.style.display = "none";
  content.style.display = "block";
  clearBtn.style.display = "inline-flex";

  // Stats
  const totals = history.map(h => h.total).filter(t => t != null);
  document.getElementById("statAttempts").textContent = history.length;
  document.getElementById("statAverage").textContent = totals.length
    ? (totals.reduce((a,b) => a+b, 0) / totals.length).toFixed(1)
    : "‚Äì";
  document.getElementById("statBest").textContent = totals.length
    ? Math.max(...totals)
    : "‚Äì";

  // Table
  const tbody = document.getElementById("historyTableBody");
  tbody.innerHTML = history.slice().reverse().map((h, i) => {
    const realIdx = history.length - 1 - i;
    const d = new Date(h.date);
    const dateStr = `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
    const timeStr = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
    return `<tr>
      <td>${dateStr}<br><span style="font-size:.75rem;color:var(--ink-muted)">${timeStr}</span></td>
      <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(h.topic)}</td>
      <td class="history-score">${h.content ?? "‚Äì"}/15</td>
      <td class="history-score">${h.language ?? "‚Äì"}/15</td>
      <td class="history-score" style="font-size:1.05rem;">${h.total ?? "‚Äì"}/15</td>
      <td><button class="history-delete" onclick="deleteHistoryEntry(${realIdx})" title="L√∂schen">‚úï</button></td>
    </tr>`;
  }).join("");

  // Chart
  renderProgressChart();
}

function renderProgressChart() {
  const history = getHistory();
  if (!history.length) return;

  const ctx = document.getElementById("progressChart");
  if (!ctx) return;

  // Destroy old chart
  if (progressChartInstance) {
    progressChartInstance.destroy();
    progressChartInstance = null;
  }

  const isDark = document.documentElement.getAttribute("data-theme") === "dark";
  const gridColor = isDark ? "rgba(255,255,255,0.08)" : "rgba(0,0,0,0.06)";
  const textColor = isDark ? "#b0b0c8" : "#8888a4";

  const labels = history.map((h, i) => `#${i + 1}`);
  const totals = history.map(h => h.total);
  const contents = history.map(h => h.content);
  const langs = history.map(h => h.language);

  progressChartInstance = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Gesamt (/15 NP)",
          data: totals,
          borderColor: "#2563eb",
          backgroundColor: "rgba(37,99,235,0.1)",
          fill: true,
          tension: 0.3,
          borderWidth: 2.5,
          pointRadius: 4,
          pointBackgroundColor: "#2563eb"
        },
        {
          label: "Inhalt (/15 NP)",
          data: contents,
          borderColor: "#059669",
          backgroundColor: "transparent",
          tension: 0.3,
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 3,
          pointBackgroundColor: "#059669"
        },
        {
          label: "Sprache (/15 NP)",
          data: langs,
          borderColor: "#f59e0b",
          backgroundColor: "transparent",
          tension: 0.3,
          borderWidth: 1.5,
          borderDash: [4, 3],
          pointRadius: 3,
          pointBackgroundColor: "#f59e0b"
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: textColor, font: { size: 11 } }
        }
      },
      scales: {
        y: {
          min: 0, max: 15,
          grid: { color: gridColor },
          ticks: { color: textColor, stepSize: 3 }
        },
        x: {
          grid: { display: false },
          ticks: { color: textColor }
        }
      }
    }
  });
}

/* ================= INIT UPDATES ================= */
// Theme and session recovery are now handled in the main window.onload above
</script>

</body>
</html>
