<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>St. Anna Mediation Trainer</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
/* --- Original Design (kept) --- */

:root {
--primary:#2c3e50;
--secondary:#34495e;
--accent:#2980b9;
--bg:#f4f6f7;
--text:#2c3e50;
--paper:#ffffff;
--warning:#c0392b;
}

body{
font-family:'Segoe UI','Roboto','Helvetica',sans-serif;
background:var(--bg);
margin:0;
color:var(--text);
min-height:100vh;
display:flex;
flex-direction:column;
}

/* LOGIN */

#login-screen{
position:fixed;
inset:0;
background:var(--primary);
display:flex;
justify-content:center;
align-items:center;
z-index:9999;
}

.login-box{
background:white;
padding:2.5rem;
border-radius:8px;
box-shadow:0 10px 25px rgba(0,0,0,.2);
text-align:center;
max-width:420px;
width:90%;
}

.login-error{color:var(--warning);display:none;font-weight:bold;}

/* HEADER */

#app-wrapper{display:none;flex-direction:column;min-height:100vh;}

header{
background:var(--primary);
color:white;
padding:1rem 2rem;
display:flex;
justify-content:space-between;
align-items:center;
}

nav{
background:white;
padding:0 2rem;
display:flex;
gap:1rem;
box-shadow:0 2px 4px rgba(0,0,0,.05);
}

nav button{
background:none;
border:none;
padding:1rem .5rem;
cursor:pointer;
font-weight:600;
color:var(--secondary);
border-bottom:3px solid transparent;
}

nav button.active{
color:var(--accent);
border-bottom-color:var(--accent);
}

main{
flex:1;
max-width:1000px;
margin:2rem auto;
padding:1rem;
width:100%;
}

section{
display:none;
background:var(--paper);
padding:2rem;
border-radius:8px;
box-shadow:0 2px 6px rgba(0,0,0,.05);
margin-bottom:2rem;
}

section.active{display:block;}

.task-box{
background:#eef2f5;
border-left:5px solid var(--accent);
padding:1.2rem;
margin:1rem 0;
}

textarea{
width:100%;
min-height:400px;
padding:1.2rem;
font-family:'Courier New',monospace;
font-size:1rem;
border:1px solid #ddd;
border-radius:4px;
}

.btn{
background:var(--accent);
color:white;
border:none;
padding:.7rem 1.4rem;
border-radius:4px;
cursor:pointer;
font-weight:600;
}

.btn:hover{background:#1f6391;}

.loader{
border:4px solid #eee;
border-top:4px solid var(--accent);
border-radius:50%;
width:35px;
height:35px;
animation:spin 1s linear infinite;
display:none;
margin:20px auto;
}

@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>

<!-- LOGIN -->

<div id="login-screen">
<div class="login-box">
<h2>ðŸ”’ Zugriff geschÃ¼tzt</h2>
<p>Bitte Passwort eingeben</p>

<input type="password" id="accessPassword"
placeholder="Passwort..."
onkeyup="if(event.key==='Enter')checkPassword()">

<br><br>

<button class="btn" onclick="checkPassword()">Starten</button>

<div id="loginError" class="login-error">Falsches Passwort</div>
</div>
</div>

<!-- APP -->

<div id="app-wrapper">

<header>
<h1>Abitur Mediation Trainer <span style="font-size:.8rem">St. Anna</span></h1>
<div style="opacity:.8">2026</div>
</header>

<nav>
<button id="nav-setup" class="active" onclick="nav('setup')">1. Setup</button>
<button id="nav-task" onclick="nav('task')">2. Task</button>
<button id="nav-write" onclick="nav('write')">3. Writing</button>
<button id="nav-feedback" onclick="nav('feedback')">4. Feedback</button>
</nav>

<main>

<!-- SETUP -->

<section id="setup" class="active">

<h2>PrÃ¼fung erstellen</h2>

<label>Themenfeld</label><br>

<select id="topicSelect">
<option>Science & Technology</option>
<option>Global Challenges</option>
<option>Media & Society</option>
<option>Politics & Change</option>
<option>Future of Work</option>
</select>

<br><br>

<label>LÃ¤nge (WÃ¶rter)</label><br>

<input type="number" id="sourceLength" value="600">

<br><br>

<button class="btn" onclick="generateExam()">Generieren</button>

<div id="setupLoader" class="loader"></div>

</section>

<!-- TASK -->

<section id="task">

<h2>Mediation Task</h2>

<div class="task-box" id="taskInstruction">
Bitte zuerst generieren.
</div>

<h3>Source Text</h3>

<h4 id="articleTitle"></h4>

<div id="articleBody"></div>

<p>WÃ¶rter: <span id="wordCountLabel">0</span></p>

</section>

<!-- WRITE -->

<section id="write">

<h2>Student Response</h2>

<textarea id="studentText" oninput="autoSave()"></textarea>

<br>

WÃ¶rter: <b id="currentWordCount">0</b>

<br><br>

<button class="btn" onclick="submitForCorrection()">Abgeben</button>

</section>

<!-- FEEDBACK -->

<section id="feedback">

<h2>Bewertung</h2>

<div id="feedbackLoader" class="loader"></div>

<div id="feedbackContent"></div>

</section>

</main>

<footer style="text-align:center;padding:2rem;color:#999">
Â© 2026 St. Anna Gymnasium
</footer>

</div>

<script>

/* ================= CONFIG ================= */

const API_BASE =
"https://sag-abi-mediation-api.sanktannagymnasium.workers.dev";

const ACCESS_PASSWORD = "stanna2026";

const CONFIG = {
storedData:{}
};

/* ================= LOGIN ================= */

function checkPassword(){

const input=document.getElementById("accessPassword").value.trim();
const err=document.getElementById("loginError");

if(input===ACCESS_PASSWORD){

sessionStorage.setItem("access","1");

document.getElementById("login-screen").style.display="none";
document.getElementById("app-wrapper").style.display="flex";

err.style.display="none";

}else{
err.style.display="block";
}
}

/* ================= INIT ================= */

window.onload=function(){

if(sessionStorage.getItem("access")==="1"){
document.getElementById("login-screen").style.display="none";
document.getElementById("app-wrapper").style.display="flex";
}

const saved=localStorage.getItem("exam_data");
if(saved){
CONFIG.storedData=JSON.parse(saved);
renderExam(CONFIG.storedData);
}

const st=localStorage.getItem("student_text");
if(st){
document.getElementById("studentText").value=st;
autoSave();
}

};

/* ================= GENERATE ================= */

async function generateExam(){

const topic=document.getElementById("topicSelect").value;
const length=document.getElementById("sourceLength").value;

document.getElementById("setupLoader").style.display="block";

try{

const res=await fetch(API_BASE+"/api/generate",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
topic:topic,
source_len_words:Number(length)
})
});

if(!res.ok) throw new Error("Serverfehler");

const data=await res.json();

const content={
headline:"Generated Task",
article_text:data.source_text_de,
task_instruction:data.task_en
};

CONFIG.storedData=content;
localStorage.setItem("exam_data",JSON.stringify(content));

renderExam(content);
nav("task");

}catch(e){
alert("Fehler: "+e.message);
}

document.getElementById("setupLoader").style.display="none";
}

/* ================= RENDER ================= */

function renderExam(d){

document.getElementById("taskInstruction").innerText=d.task_instruction;
document.getElementById("articleTitle").innerText=d.headline;

document.getElementById("articleBody").innerHTML=
d.article_text.split("\n")
.map(p=>`<p>${p}</p>`).join("");

document.getElementById("wordCountLabel").innerText=
countWords(d.article_text);

}

/* ================= SUBMIT ================= */

async function submitForCorrection(){

const text=document.getElementById("studentText").value;

if(countWords(text)<50){
alert("Text zu kurz");
return;
}

nav("feedback");

document.getElementById("feedbackLoader").style.display="block";

try{

const res=await fetch(API_BASE+"/api/grade",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
source_text_de:CONFIG.storedData.article_text,
task_en:CONFIG.storedData.task_instruction,
student_text_en:text
})
});

if(!res.ok) throw new Error("Serverfehler");

const data=await res.json();

const out=`
# Bewertung

**Gesamt: ${data.scores.total}/10**

## Inhalt ${data.scores.content_textstructure}/4

## Sprache ${data.scores.language}/6

## Feedback

${data.feedback}

## Korrekturen

${data.corrections}
`;

document.getElementById("feedbackContent").innerHTML=
marked.parse(out);

}catch(e){
alert("Fehler: "+e.message);
}

document.getElementById("feedbackLoader").style.display="none";
}

/* ================= UTILS ================= */

function autoSave(){

const t=document.getElementById("studentText").value;

localStorage.setItem("student_text",t);

document.getElementById("currentWordCount").innerText=
countWords(t);

}

function countWords(s){
return s.trim().split(/\s+/).filter(a=>a).length;
}

function nav(id){

document.querySelectorAll("section")
.forEach(s=>s.classList.remove("active"));

document.querySelectorAll("nav button")
.forEach(b=>b.classList.remove("active"));

document.getElementById(id).classList.add("active");
document.getElementById("nav-"+id).classList.add("active");

}

</script>

</body>
</html>
